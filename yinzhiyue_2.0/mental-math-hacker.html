<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <title>心算駭客：199X Mental Math Hacker: 199X</title>
    <meta name="viewport" content="width=1024" />
    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,700&display=swap" rel="stylesheet">
    <style>
      html, body, #root {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background: #121622;
        font-family: 'IBM Plex Mono', 'Consolas', 'monospace';
      }
      /* CRT效果與主題 */
      .crt {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        filter: saturate(1.1) contrast(1.12) brightness(1.15);
        border-radius: 3vw 3vw 3vw 3vw / 5vw 5vw 5vw 5vw;
        box-shadow: 0 0 80px 0 #000a, 0 0 0 12px #232420 inset;
      }
      .crt-green .crt-content { color: #74ff7e; text-shadow: 0 0 8px #7fffad, 0 0 16px #47d76e; background: #161c1a; }
      .crt-amber .crt-content { color: #ffe29f; text-shadow: 0 0 8px #ffea8d, 0 0 16px #ffba47; background: #1a1710; }
      .crt-blue .crt-content { color: #67e2ff; text-shadow: 0 0 8px #a7eaff, 0 0 16px #1197cd; background: #10131a; }
      .crt-content {
        width: 900px; max-width: 96vw; height: 540px; max-height: 90vh;
        position: relative; z-index: 2; padding: 38px 48px 38px 48px;
        font-size: 2rem; display: flex; flex-direction: column;
        justify-content: center; align-items: center; background: transparent;
      }
      .crt-overlay {
        position: absolute; inset: 0; pointer-events: none; z-index: 3;
        background:
          radial-gradient(ellipse at 50% 48%, transparent 60%, #000b 100%),
          repeating-linear-gradient(135deg, transparent 0 7px, #2223 9px 13px);
        mix-blend-mode: multiply;
        border-radius: inherit;
      }
      .crt-scanlines {
        position: absolute; inset: 0; pointer-events: none; z-index: 4;
        background: repeating-linear-gradient(
          to bottom,
          transparent 0px,
          rgba(0,0,0,0.16) 2px,
          transparent 4px,
          transparent 10px
        );
        opacity: 0.2;
        border-radius: inherit;
      }
      /* TitleScreen */
      .titlescreen { width: 100%; height: 100%; text-align: center; position: relative; user-select: none; padding-top: 50px;}
      .titlescreen-logo { width: 540px; max-width: 82vw; filter: drop-shadow(0 0 48px #00ffae70); margin-top: 30px;}
      .titlescreen-press { margin-top: 56px; font-size: 2.3rem; letter-spacing: 0.18em; text-shadow: 0 0 16px #0f0, 0 0 32px #3ffb;}
      .titlescreen-theme { margin-top: 48px; font-size: 1.15rem;}
      .titlescreen-theme button { background: none; border: 2px solid #7ff; color: inherit; font: inherit; margin: 0 8px; padding: 2px 12px; border-radius: 6px; opacity: 0.6; cursor: pointer; outline: none; transition: opacity 0.2s, border 0.2s;}
      .titlescreen-theme button.active { opacity: 1; border: 2px solid #fff;}
      .titlescreen-footer { position: absolute; bottom: 18px; left: 0; width: 100%; text-align: center; font-size: 0.92rem; color: #aaa; opacity: 0.75;}
      /* ModeSelect */
      .modeselect { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
      .modeselect h1 { font-size: 2.3em; margin-bottom: 55px; letter-spacing: 0.10em;}
      .modeselect button { margin: 22px 0; padding: 12px 36px; background: rgba(0,0,0,0.1); border: 2px solid #7ff; color: inherit; font: inherit; font-size: 1.25em; border-radius: 8px; cursor: pointer; transition: border 0.18s, background 0.18s; outline: none;}
      .modeselect button:hover, .modeselect button:active { border: 2px solid #fff; background: rgba(100,255,150,0.04);}
      /* ArcadeGame */
      .arcadegame { width: 100%; height: 100%; position: relative; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; }
      .arcadegame-header { width: 100%; display: flex; justify-content: space-between; font-size: 1.25rem; margin-bottom: 14px; letter-spacing: 0.12em;}
      .arcadegame-quit { background: none; border: 2px solid #7ff; color: inherit; font: inherit; padding: 3px 18px; border-radius: 6px; cursor: pointer; opacity: 0.7; margin-left: 8px;}
      .arcadegame-quit:hover,.arcadegame-quit:active { border: 2px solid #fff; opacity: 1; }
      .arcadegame-countdown { font-size: 5rem; margin-top: 80px; letter-spacing: 0.1em; text-shadow: 0 0 30px #0ff, 0 0 80px #fff3;}
      .arcadegame-result { font-size: 2.2rem; margin-top: 60px; letter-spacing: 0.08em; text-shadow: 0 0 12px #fff9, 0 0 28px #0fd3;}
      /* QuestionRenderer */
      .question-renderer { width: 95%; min-height: 120px; margin: 40px 0 0 0; display: flex; justify-content: center; align-items: center; }
      .qr-row { display: flex; align-items: center; font-size: 2.8rem; min-width: 340px; letter-spacing: 0.18em; user-select: none; }
      .qr-number { display: inline-block; margin: 0 12px; filter: drop-shadow(0 0 6px #fff7);}
      .qr-op { display: inline-block; margin: 0 10px;}
      .qr-eq { font-size: 1.45em; margin-left: 14px; margin-right: 10px; filter: drop-shadow(0 0 10px #fff6);}
      .qr-ansinput { margin-left: 8px; display: inline-flex; align-items: center; position: relative;}
      .qr-input { font-size: 1.05em; width: 90px; background: none; border: none; color: inherit; outline: none; text-align: left; letter-spacing: 0.12em; filter: drop-shadow(0 0 7px #fff7); font-family: inherit; caret-color: transparent; position: relative; z-index: 2; }
      .qr-input-green { text-shadow: 0 0 7px #7fffad; }
      .qr-input-amber { text-shadow: 0 0 7px #ffd23b; }
      .qr-input-blue { text-shadow: 0 0 7px #67e2ff; }
      .qr-cursor { display: inline-block; margin-left: -8px; color: #fff; opacity: 0.85; animation: blink-cursor 1s steps(1) infinite; font-size: 1.2em; position: absolute; right: 0;}
      @keyframes blink-cursor { 0%, 60% { opacity: 0.86; } 61%, 100% { opacity: 0; } }
      .qr-blank { display: inline-block; width: 44px; opacity: 0.15;}
      /* Operator SVG Animation (簡化) */
      .qr-mult svg .op-mult-g { filter: drop-shadow(0 0 13px #0ff) drop-shadow(0 0 24px #fff8);}
      .qr-plus svg .op-plus-g { filter: drop-shadow(0 0 9px #fff7);}
      .qr-minus svg .op-minus-g { filter: drop-shadow(0 0 7px #f0f9);}
      .qr-div svg .op-div-g { filter: drop-shadow(0 0 8px #aff7);}
      /* Overlay */
      .overlay-bg {
        position: absolute; inset: 0; background: rgba(24,32,45,0.92);
        display: flex; justify-content: center; align-items: center; z-index: 99;
      }
      .overlay-box {
        background: #161f27dd; border: 2px solid #0ff; border-radius: 15px;
        box-shadow: 0 0 28px #0ff5, 0 0 8px #fff4 inset;
        padding: 36px 54px; text-align: center; color: #f7f7ff; min-width: 400px;
      }
      .overlay-score { font-size: 2.2em; margin: 16px 0 10px 0; letter-spacing: 0.08em;}
      .overlay-details { font-size: 1.1em; margin-bottom: 18px; opacity: 0.92;}
      .overlay-lb-title { font-size: 1.15em; margin: 10px 0 2px 0; color: #0ff; letter-spacing: 0.11em;}
      .overlay-lb { width: 100%; margin: 0 auto 16px auto; border-collapse: collapse; font-family: inherit; font-size: 1.05em;}
      .overlay-lb td { padding: 2px 16px; border-bottom: 1px solid #1999;}
      .overlay-actions { margin-top: 12px;}
      .overlay-actions button { margin: 0 25px; padding: 9px 26px; background: #1c2c3c; color: #0ff; border: 2px solid #0ff; font: inherit; font-size: 1.10em; border-radius: 8px; cursor: pointer; opacity: 0.88; transition: border 0.18s, box-shadow 0.22s;}
      .overlay-actions button:hover { border: 2px solid #fff; box-shadow: 0 0 10px #0ff4; opacity: 1;}
    </style>
  </head>
  <body>
    <div id="root"></div>
    <!-- 音效檔案建議放於 audio/ 資料夾。logo 請放在 assets/logo.png -->
    <script type="text/javascript">
      // ===== 工具函式 =====
      function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
      function rand(a,b) { return a+Math.floor(Math.random()*(b-a+1)); }
      function calc(exprs) {
        let stack=[];
        for(let i=0;i<exprs.length;i++){
          if(typeof exprs[i]==="number") stack.push(exprs[i]);
          else if(exprs[i]==="x"){let b=stack.pop(),a=stack.pop();stack.push(a*b);}
          else if(exprs[i]==="+"){let b=stack.pop(),a=stack.pop();stack.push(a+b);}
          else if(exprs[i]==="-"){let b=stack.pop(),a=stack.pop();stack.push(a-b);}
          else if(exprs[i]==="/"){let b=stack.pop(),a=stack.pop();stack.push(Math.floor(a/b));}
        }
        return stack[0];
      }
      function genArcadeQuestion(lvl){
        let n1,n2,n3,op1,op2,exprs;
        const t=Date.now();
        if(lvl<3){
          n1=rand(2,9);n2=rand(2,9);op1=pick(["x","+","-"]);exprs=[n1,op1,n2];
          return {exprs,ans:calc(exprs),start:t};
        }
        if(lvl<5){
          n1=rand(10,19);n2=rand(2,9);op1=pick(["x","+","-"]);exprs=[n1,op1,n2];
          return {exprs,ans:calc(exprs),start:t};
        }
        if(lvl<8){
          n1=rand(10,29);n2=rand(10,29);op1=pick(["x","+","-"]);exprs=[n1,op1,n2];
          return {exprs,ans:calc(exprs),start:t};
        }
        n1=rand(10,49);n2=rand(10,49);n3=rand(2,19);op1=pick(["x","+"]);op2=pick(["-","+"]);
        if(Math.random()>0.5){exprs=[n1,op1,n2,op2,n3];}
        else{exprs=[n1,op2,n2,op1,n3];}
        return {exprs,ans:calc(exprs),start:t};
      }
      // ===== 音效管理簡易版 =====
      const SFX = {
        type: ()=>playS("/audio/type.mp3"),
        blip: ()=>playS("/audio/blip.mp3"),
        operator: (op)=>{
          if(op==="x")playS("/audio/mult_buzz.mp3");
          else if(op==="-")playS("/audio/minus_laser.mp3");
          else if(op==="+")playS("/audio/plus_up.mp3");
          else if(op==="/")playS("/audio/div_slice.mp3");
          else playS("/audio/blip.mp3");
        },
        correct: ()=>playS("/audio/correct.mp3"),
        wrong: ()=>playS("/audio/wrong.mp3"),
        countdown: ()=>playS("/audio/countdown.mp3"),
      };
      function playS(src){
        const a=new Audio(src);a.volume=0.5;a.play();
      }
      // ===== BGM管理簡易版 =====
      const BGM_URLS=[
        "/audio/synthwave1.mp3",
        "/audio/chiptune1.mp3",
        "/audio/synthwave2.mp3",
      ];
      let _bgmAudio;
      function startBGM(){
        if(_bgmAudio) return;
        let idx=0;
        _bgmAudio=new Audio(BGM_URLS[idx]);
        _bgmAudio.volume=0.45;
        _bgmAudio.loop=false;
        _bgmAudio.onended=()=>{
          idx=(idx+1)%BGM_URLS.length;
          _bgmAudio.src=BGM_URLS[idx];
          _bgmAudio.play();
        };
        _bgmAudio.play().catch(()=>{});
        window.removeEventListener("pointerdown",startBGM);
      }
      window.addEventListener("pointerdown", startBGM);

      // ==== View State（簡易版） ====
      let state = {
        scene: "title", // title, mode, arcade
        theme: "green",
        arcade: null,
      };
      function setState(next) {
        state = {...state, ...next};
        render();
      }
      // ---- Main Render ----
      function render() {
        const root = document.getElementById("root");
        root.innerHTML = "";
        // CRT wrapper
        const crt = document.createElement("div");
        crt.className = `crt crt-${state.theme}`;
        crt.innerHTML = `
          <div class="crt-overlay"></div>
          <div class="crt-content" id="crt-content"></div>
          <div class="crt-scanlines"></div>
        `;
        root.appendChild(crt);
        const content = crt.querySelector("#crt-content");
        if(state.scene==="title") renderTitleScreen(content);
        else if(state.scene==="mode") renderModeSelect(content);
        else if(state.scene==="arcade") renderArcadeGame(content);
      }

      function renderTitleScreen(container) {
        SFX.blip();
        container.innerHTML = `
          <img src="assets/logo.png" class="titlescreen-logo" alt="心算駭客 Mental Math Hacker: 199X" />
          <div class="titlescreen-press" id="pressstart">PRESS START</div>
          <div class="titlescreen-theme">
            THEME:
            <button id="theme-green"${state.theme==="green"?" class='active'":""}>螢光綠</button>
            <button id="theme-amber"${state.theme==="amber"?" class='active'":""}>琥珀</button>
            <button id="theme-blue"${state.theme==="blue"?" class='active'":""}>深藍</button>
          </div>
          <div class="titlescreen-footer">© 2025 - MENTAL MATH HACKER: 199X</div>
        `;
        let show=true;
        setInterval(()=>{ 
          document.getElementById("pressstart").style.visibility = show ? "visible":"hidden"; show=!show;
        }, 500);
        container.onclick = ()=>{ setState({scene:"mode"}); };
        document.getElementById("theme-green").onclick= (e)=>{e.stopPropagation();setState({theme:"green"});}
        document.getElementById("theme-amber").onclick= (e)=>{e.stopPropagation();setState({theme:"amber"});}
        document.getElementById("theme-blue").onclick= (e)=>{e.stopPropagation();setState({theme:"blue"});}
        document.body.onkeydown = (e)=>{ if(e.key==="Enter") setState({scene:"mode"}); };
      }
      function renderModeSelect(container) {
        container.innerHTML = `
          <h1>選擇模式</h1>
          <button id="btn-arcade">街機挑戰 (ARCADE MODE)</button>
          <button id="btn-story">防火牆突破 (STORY MODE)</button>
          <div style="margin-top:70px">
            <button id="btn-back">回到主畫面</button>
          </div>
        `;
        document.getElementById("btn-arcade").onclick=()=>{ setState({scene:"arcade", arcade:null});};
        document.getElementById("btn-story").onclick=()=>{ alert("故事模式開發中，敬請期待！"); };
        document.getElementById("btn-back").onclick=()=>{ setState({scene:"title"}); };
      }
      function renderArcadeGame(container) {
        let arcade = state.arcade;
        if (!arcade) {
          arcade = {
            q: genArcadeQuestion(1),
            lvl: 1,
            input: "",
            phase: "countdown",
            stats: {
              score:0,correct:0,wrong:0,streak:0,maxStreak:0,fastest:9999,longest:0,startTime:Date.now(),leaderboard:[]
            },
            msg: "",
            timeUsed: 0,
            showOverlay: false,
          };
          setState({arcade});
          return;
        }
        container.innerHTML = `
          <div class="arcadegame-header">
            <div>分數: ${Math.round(arcade.stats.score)}</div>
            <div>連擊: ${arcade.stats.streak}</div>
            <div>等級: ${arcade.lvl}</div>
            <button class="arcadegame-quit" id="btn-quit">離開</button>
          </div>
          <div id="arcade-content"></div>
        `;
        document.getElementById("btn-quit").onclick=()=>setState({scene:"mode"});
        const main = container.querySelector("#arcade-content");
        if(arcade.phase==="countdown"){
          main.innerHTML = `<div class="arcadegame-countdown" id="arcade-countdown">${arcade.msg}</div>`;
          let count=3;
          SFX.countdown();
          const timer = setInterval(()=>{
            count--;
            if(count===0){
              arcade.phase="question";
              arcade.msg="";
              setState({arcade});
              clearInterval(timer);
              setTimeout(()=>document.getElementById("answer-input")?.focus(),300);
            }else{
              arcade.msg=count.toString();
              setState({arcade});
              SFX.countdown();
            }
          },800);
        } else if(arcade.phase==="question"){
          renderQuestion(main,arcade);
        } else if(arcade.phase==="result"){
          main.innerHTML = `<div class="arcadegame-result"><span>${arcade.msg}</span>
          <span style="margin-left:30px">耗時：${(arcade.timeUsed/1000).toFixed(2)}秒</span></div>`;
        } else if(arcade.phase==="over" && arcade.showOverlay){
          renderOverlay(main,arcade);
        }
      }
      function renderQuestion(container,arcade){
        let phase=0;
        container.innerHTML=`<div class="question-renderer"><div class="qr-row" id="qr-row"></div></div>`;
        let row = container.querySelector("#qr-row");
        function step(){
          row.innerHTML="";
          for(let i=0;i<arcade.q.exprs.length;i++){
            if(phase>i) row.innerHTML += renderExpr(arcade.q.exprs[i]);
            else row.innerHTML += `<span class="qr-blank">　</span>`;
          }
          if(phase>arcade.q.exprs.length)
            row.innerHTML += `<span class="qr-eq">=</span>
              <span class="qr-ansinput"><input id="answer-input" class="qr-input qr-input-${state.theme}" value="${arcade.input}" maxlength="6" autocomplete="off" spellcheck="false" style="width:90px"/><span class="qr-cursor">▌</span></span>`;
          if(phase<=arcade.q.exprs.length)setTimeout(step,430+Math.random()*100);
          phase++;
        }
        step();
        setTimeout(()=>{ 
          const inp = document.getElementById("answer-input"); if(inp) inp.focus();
        },1200);
        document.body.onkeydown = (e)=>{
          if(arcade.phase!=="question")return;
          if(e.key==="Enter"){checkAnswer();}
          else if(/^[0-9-]$/.test(e.key)){
            if(arcade.input.length<6){arcade.input+=e.key;setState({arcade});}
          }
          else if(e.key==="Backspace"){arcade.input=arcade.input.slice(0,-1);setState({arcade});}
        };
        function checkAnswer(){
          if(arcade.input.trim()==="")return;
          const now=Date.now(),used=now-arcade.q.start;
          if(parseInt(arcade.input)===arcade.q.ans){
            SFX.correct();
            let streak=arcade.stats.streak+1;
            arcade.stats={
              ...arcade.stats,
              score:arcade.stats.score+10+Math.max(0,Math.floor(1500-used)/50),
              correct:arcade.stats.correct+1,
              streak,
              maxStreak:Math.max(streak,arcade.stats.maxStreak),
              fastest:Math.min(used,arcade.stats.fastest),
              longest:Math.max(used,arcade.stats.longest)
            };
            arcade.msg="✓ 正確！";arcade.phase="result";arcade.timeUsed=used;
            setState({arcade});
            setTimeout(()=>{nextQuestion();},900);
          }else{
            SFX.wrong();
            arcade.stats={...arcade.stats,score:Math.max(0,arcade.stats.score-8),wrong:arcade.stats.wrong+1,streak:0};
            arcade.msg="✗ 錯誤！";arcade.phase="result";arcade.timeUsed=used;
            setState({arcade});
            setTimeout(()=>{
              arcade.showOverlay=true;arcade.phase="over";
              setState({arcade});
            },900);
          }
        }
        window.checkAnswer = checkAnswer;
      }
      function renderExpr(expr){
        if(typeof expr==="number")
          return `<span class="qr-number">${expr}</span>`;
        if(expr==="x")
          return `<span class="qr-op qr-mult"><span class="op-mult"><svg width="38" height="38"><g class="op-mult-g"><rect x="12" y="0" width="14" height="38" rx="5" fill="#0ff"/><rect x="12" y="0" width="14" height="38" rx="5" fill="#0ff" transform="rotate(90 19 19)"/></g></svg></span></span>`;
        if(expr==="+")
          return `<span class="qr-op qr-plus"><span class="op-plus"><svg width="38" height="38"><g class="op-plus-g"><rect x="16" y="0" width="6" height="38" rx="3" fill="#fffa"/><rect x="0" y="16" width="38" height="6" rx="3" fill="#fffa"/></g></svg></span></span>`;
        if(expr==="-")
          return `<span class="qr-op qr-minus"><span class="op-minus"><svg width="38" height="38"><g class="op-minus-g"><rect x="0" y="16" width="38" height="6" rx="3" fill="#f0f"/></g></svg></span></span>`;
        if(expr==="/")
          return `<span class="qr-op qr-div"><span class="op-div"><svg width="38" height="38"><g class="op-div-g"><rect x="6" y="0" width="26" height="6" rx="3" fill="#aff" transform="rotate(28 19 19)"/></g></svg></span></span>`;
        return `<span class="qr-blank">${expr}</span>`;
      }
      function nextQuestion(){
        let arcade = state.arcade;
        const nextLvl=1+Math.floor(arcade.stats.correct/10);
        arcade.lvl=nextLvl;
        arcade.q=genArcadeQuestion(nextLvl);
        arcade.input="";arcade.phase="question";arcade.msg="";
        setState({arcade});
      }
      function renderOverlay(container,arcade){
        let board=[];
        try{board=JSON.parse(localStorage.getItem("crthacker_arcade_lb")||"[]");}catch{}
        let name=prompt("GAME OVER!\n請輸入3個英文字母作為代號：","HCK")||"ANON";
        name=name.slice(0,3).toUpperCase();
        board.push({name,score:Math.round(arcade.stats.score)});
        board=board.sort((a,b)=>b.score-a.score).slice(0,10);
        localStorage.setItem("crthacker_arcade_lb",JSON.stringify(board));
        arcade.stats.leaderboard=board;
        container.innerHTML=`
          <div class="overlay-bg">
            <div class="overlay-box">
              <h1>GAME OVER</h1>
              <div class="overlay-score">分數: <b>${Math.round(arcade.stats.score)}</b></div>
              <div class="overlay-details">
                <div>答對: ${arcade.stats.correct} 題</div>
                <div>最長連擊: ${arcade.stats.maxStreak}</div>
                <div>最快反應: ${(arcade.stats.fastest/1000).toFixed(2)} 秒</div>
                <div>最慢反應: ${(arcade.stats.longest/1000).toFixed(2)} 秒</div>
              </div>
              <div class="overlay-lb-title">街機排行榜 TOP 10</div>
              <table class="overlay-lb">
                <tbody>
                  ${board.map((row,i)=>`<tr><td>${i+1}.</td><td>${row.name}</td><td>${row.score}</td></tr>`).join("")}
                </tbody>
              </table>
              <div class="overlay-actions">
                <button id="btn-restart">再來一次</button>
                <button id="btn-back">回主選單</button>
              </div>
            </div>
          </div>
        `;
        document.getElementById("btn-restart").onclick=()=>{
          setState({arcade:null});
        };
        document.getElementById("btn-back").onclick=()=>{
          setState({scene:"mode",arcade:null});
        };
      }
      window.onload = render;
    </script>
    <!-- 音效與logo請對應存放於 /audio/ 與 /assets/ 資料夾 -->
  </body>
</html>