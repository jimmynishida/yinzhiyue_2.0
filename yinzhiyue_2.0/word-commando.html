<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>文字特攻隊：九零連線 (Word Commando: 90's Connect)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... CSS 與上次修正版相同 ... */
  </style>
</head>
<body>
<div id="tutorial-overlay" class="tutorial-overlay">
    </div>
<div class="pixel-bg" id="app">
    <div id="game-content"></div> </div>
<audio id="bgm" loop preload="auto"></audio>
<audio id="sfx" preload="auto"></audio>
<script>
    // --- ★★★ 徹底重構的 JavaScript ★★★ ---
    const THEMES = [ { level: 1, key: "star-movies", name: "周星馳電影", icon: "assets/folder-icon-movie.png", bgm: "audio/bgm-chiptune1.mp3", words: ["賭聖", "9527", "無厘頭", "重播"], noise: ["林正英", "珍珠奶茶", "A面B面", "麥當勞", "大豬公", "ICQ", "超級賽亞人"], }, { level: 2, key: "zombie", name: "香港殭屍片", icon: "assets/folder-icon-zombie.png", bgm: "audio/bgm-chiptune2.mp3", words: ["林正英", "暫時停止呼吸", "糯米", "桃木劍"], noise: ["賭聖", "珍珠奶茶", "彈珠汽水", "龜派氣功", "大豬公", "ICQ", "Walkman"], }, { level: 3, key: "dragonball", name: "七龍珠", icon: "assets/folder-icon-dbz.png", bgm: "audio/bgm-chiptune3.mp3", words: ["超級賽亞人", "龜派氣功", "天下第一武道會", "那美克星"], noise: ["林正英", "珍珠奶茶", "A面B面", "賭聖", "大豬公", "ICQ"], }, ];
    const SFX = { dialup: "audio/sfx-dialup.mp3", select: "audio/sfx-select.mp3", success: "audio/sfx-success.mp3", error: "audio/sfx-error.mp3" };
    let GAME = { screen: "dialup", maxUnlockedLevel: 1, currentLevel: 1, lives: 3, isPaused: false, timeLeft: 60, words: [], selectedIdx: [], foundWords: [] };
    let timerId = null;

    function shuffle(arr) { let a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a }
    function sample(arr,n=1){const s=shuffle(arr);return n===1?s[0]:s.slice(0,n)}
    function playSFX(src){try{const sfx=document.getElementById("sfx");sfx.src=src;sfx.play()}catch(e){}}
    function setBGM(src){try{const bgm=document.getElementById("bgm");if(!src){bgm.pause();return}bgm.src=src;bgm.play()}catch(e){}}
    function resetGameState(){GAME.timeLeft=60;GAME.words=[];GAME.selectedIdx=[];GAME.foundWords=[];GAME.lives=3;GAME.isPaused=false}

    function createElement(tag,o={},c=[]){const el=document.createElement(tag);Object.keys(o).forEach(k=>{if(k==='className')el.className=o[k];else if(k==='textContent')el.textContent=o[k];else if(k==='onclick')el.onclick=o[k];else if(k==='style')Object.assign(el.style,o[k]);else el.setAttribute(k,o[k])});c.forEach(ch=>{if(ch)el.appendChild(typeof ch==='string'?document.createTextNode(ch):ch)});return el}
    function buildWindow(t,c,i=null){const T=[];if(i){T.push(createElement('img',{src:i,style:{width:'22px',marginRight:'4px'}}))}T.push(createElement('span',{textContent:t}));return createElement('div',{className:'win95-window'},[createElement('div',{className:'win95-titlebar'},[createElement('div',{className:'win95-title'},T)]),createElement('div',{className:'win95-content'},[c])])}

    function render(screen) {
        GAME.screen = screen;
        const contentContainer = document.getElementById("game-content");
        contentContainer.innerHTML = "";
        let screenElement;
        switch(screen) {
            case "dialup": screenElement = dialupScreen(); break;
            case "levelSelect": screenElement = levelSelectScreen(); break;
            case "playing": screenElement = gameScreen(); break;
            case "levelClear": screenElement = levelResultScreen(true); break;
            case "gameOver": screenElement = levelResultScreen(false); break;
            default: screenElement = createElement('div', {textContent: 'Error'});
        }
        contentContainer.appendChild(screenElement);
    }

    function dialupScreen(){const s=createElement('div',{id:'dialup-status',className:'dialup-status',textContent:'撥接音效中...'});const b=createElement('button',{className:'win95-btn start-btn',textContent:'START',style:{display:'none'}});b.onclick=()=>render("levelSelect");const c=createElement('div',{className:'dialup-screen'},[createElement('div',{className:'dialup-animation'}),createElement('div',{className:'dialup-text',textContent:'正在連線到 90 年代...'}),s,b]);setTimeout(()=>playSFX(SFX.dialup),150);setTimeout(()=>{s.textContent="連線成功！";b.style.display=""},3800);return buildWindow('載入中...',c)}
    function levelSelectScreen(){const r=createElement('div',{className:'folders-row'});THEMES.forEach(t=>{const l=t.level>GAME.maxUnlockedLevel;const f=createElement('div',{className:`folder-icon ${l?'locked':''}`,title:l?'鎖定中':t.name},[createElement('img',{src:t.icon,alt:t.name}),createElement('div',{className:'folder-label',textContent:`關卡 ${t.level}`})]);if(!l){f.onclick=()=>{GAME.currentLevel=t.level;resetGameState();setBGM(t.bgm);GAME.words=shuffle([...t.words,...sample(t.noise,16-t.words.length)]);render("playing");startTimer()}}r.appendChild(f)});return buildWindow('關卡選擇',createElement('div',{className:'level-select-screen'},[createElement('h1',{textContent:'選擇挑戰關卡'}),r]))}

    // --- ★★★ 徹底重構的遊戲畫面與事件處理 ★★★ ---
    function handleBoardClick(event) {
        if (GAME.isPaused) return;
        const target = event.target.closest('.word-btn');
        if (!target || target.disabled) return;
        
        const index = parseInt(target.dataset.index, 10);
        const indexInSelection = GAME.selectedIdx.indexOf(index);

        if (indexInSelection > -1) {
            GAME.selectedIdx.splice(indexInSelection, 1);
            target.classList.remove('selected');
        } else {
            GAME.selectedIdx.push(index);
            target.classList.add('selected');
            playSFX(SFX.select);
        }
    }

    function gameScreen() {
        const theme = THEMES.find(t => t.level === GAME.currentLevel);
        const board = createElement('div', { className: 'word-board' });
        // **修正**：使用 addEventListener 而非 .onclick
        board.addEventListener('click', handleBoardClick);

        GAME.words.forEach((word, i) => {
            const isFound = GAME.foundWords.includes(word);
            const btnOptions = { className: 'word-btn', textContent: word, disabled: isFound, 'data-index': i };
            const btn = createElement('button', btnOptions);
            if (GAME.selectedIdx.includes(i)) btn.classList.add("selected");
            if (isFound) btn.style.opacity = 0.5;
            board.appendChild(btn);
        });

        const hud = createElement('div', { className: 'game-hud' }, [ createElement('span', { className: 'timer' }, [ `🕒 `, createElement('span', { id: 'timer', textContent: GAME.timeLeft }), 's' ]), createElement('span', { textContent: `生命值: ${'♥'.repeat(GAME.lives)}` }), createElement('button', { className: 'win95-btn', textContent: '|| 暫停', onclick: togglePause }) ]);
        const submitBtn = createElement('button', { className: 'win95-btn', textContent: '送出連線' });
        submitBtn.onclick = () => {
            if (GAME.selectedIdx.length === 0) return;
            let line = GAME.selectedIdx.map(i => GAME.words[i]);
            let allCorrect = line.every(w => theme.words.includes(w));
            if (allCorrect) {
                playSFX(SFX.success);
                GAME.foundWords.push(...line);
                if (GAME.foundWords.length >= theme.words.length) {
                    GAME.screen = "levelClear";
                    GAME.maxUnlockedLevel = Math.max(GAME.maxUnlockedLevel, GAME.currentLevel + 1);
                    clearInterval(timerId);
                }
            } else {
                playSFX(SFX.error);
                GAME.lives--;
                if (GAME.lives <= 0) {
                    GAME.screen = "gameOver";
                    clearInterval(timerId);
                }
            }
            GAME.selectedIdx = [];
            render(GAME.screen);
        };
        const cancelBtn = createElement('button', { className: 'win95-btn', textContent: '取消', onclick: () => { GAME.selectedIdx = []; render("playing"); } });
        const content = createElement('div', { className: 'game-play' }, [ hud, createElement('h2', {textContent: theme.name, style:{margin:'10px 0'}}), board, createElement('div', { className: 'game-actions' }, [submitBtn, cancelBtn]) ]);
        
        if (GAME.isPaused) {
            const pauseMenu = createElement('div', {className: 'win95-window', style: {position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', zIndex: 10}}, [
                createElement('div', {className: 'win95-content', style: {textAlign: 'center'}}, [
                    createElement('h2', {textContent: '遊戲已暫停'}),
                    createElement('button', {className: 'win95-btn', textContent: '繼續遊戲', onclick: togglePause})
                ])
            ]);
            const pauseOverlay = createElement('div', {className: 'pause-overlay', style:{display:'flex'}}, [pauseMenu]);
            content.appendChild(pauseOverlay);
        }
        return buildWindow(`關卡 ${theme.level}`, content, theme.icon);
    }

    function levelResultScreen(isWin){const t=isWin?'關卡完成！':'挑戰失敗！';const m=isWin?'太棒了！你解鎖了下一關！':'別氣餒，再試一次吧！';const b=createElement('button',{className:'win95-btn start-btn'});if(isWin){if(GAME.currentLevel<THEMES.length){b.textContent='前往下一關';b.onclick=()=>{GAME.currentLevel++;GAME.screen='levelSelect';render(GAME.screen)}}else{b.textContent='恭喜全部通關！';b.onclick=()=>{GAME.screen='levelSelect';render(GAME.screen)}}}else{b.textContent='重新挑戰本關';b.onclick=()=>{GAME.screen='levelSelect';render(GAME.screen)}}const c=createElement('div',{className:'level-result-screen'},[createElement('div',{className:'level-result-title',textContent:t}),createElement('p',{textContent:m}),b]);return buildWindow('結算',c)}
    function startTimer(){if(timerId)clearInterval(timerId);timerId=setInterval(()=>{if(GAME.isPaused||GAME.screen!=="playing")return;GAME.timeLeft--;const t=document.getElementById('timer');if(t)t.textContent=GAME.timeLeft;if(GAME.timeLeft<=0){clearInterval(timerId);GAME.screen="gameOver";render(GAME.screen)}},1000)}
    function togglePause(){GAME.isPaused=!GAME.isPaused;render(GAME.screen)}

    function initTutorial(){const o=document.getElementById('tutorial-overlay');const c=document.getElementById('tutorial-close-btn');const k='tutorialShown_word_commando';const s=()=>{window.onload=null;render(GAME.screen)};if(!sessionStorage.getItem(k)){if(o)o.style.display='flex';if(c){c.onclick=function(){if(o)o.style.display='none';sessionStorage.setItem(k,'true');s()}}}else{s()}}
    window.onload=initTutorial;
</script>
</body>
</html>